# VPN 服务

## 1.VPN 原理

从网络协议栈出发来理解 `VPN` 是最快的，当您连接 `VPN` 后，系统会创建一个虚拟网卡（如 `tun0`），然后修改路由表，让所有流量都默认走这个虚拟网卡。

你原本访问 `www.baidu.com`（比如 `IP` 是 `180.101.49.11`）：

- **不接 VPN：**
  - 网络层目的地址是 `180.101.49.11`
  - 报文直接丢给物理网卡（`eth0`）发出
- **接 VPN 后：**
  - 应用层和传输层的内容完全没变（还是访问百度）
  - 但这个报文 **不再直接发出**，而是：
    - 被路由到虚拟网卡（`tun0`）
    - 被 `VPN` 程序读取、加密、打包（包含原本的 `IP`）
    - 然后再重新构造一个 `IP` 包，但是目的 `IP` 是 `VPN` 服务器（比如 `10.0.0.1`）
    - 最终才由物理网卡发出
    - 发出后由目标 `VPN` 来进行报文的处理后，再来重新发送原本的 `IP`

> [!IMPORTANT]
>
> 补充：那么 `Nginx/tabby` 业务代理技术和 `VPN` 系统发代理技术有什么差别呢？
>
> - 表面区别是工作层次不同
> - 深层区别是效果目的不同
>   - 由于 `VPN` 工作在 `VPN` 是一种为请求 `IP` 在此进行 `IP` 封装的技术，主要目的在于最高效率的进行流量转发
>   - 而 `VPN` 技术转发的 `HTTP` 报文通常都有 `SSL` 证书和密钥做加密，无法获取应用层数据，但是 `HTTP(s)` 报文经过业务代理服务器是可以被解密的

## 2.VPN 作用

`ok`，那么假设给您三台机器 `A、B、C`，一开始 `A` 访问 `C` 上的网站畅通无阻，但是我为什么需要把 `B` 搭建为 `VPN` 呢？是什么理由或者网络结构迫使我这么做呢？这里列举一个最常用的场景：

- `C` 是公司服务或学校服务，只允许内网 `IP` 或特定 `IP` 段访问
- `A` 是在外网或流量出不去的公网主机
- 你让 `A` 连上 `VPN` 到 `B`（`B` 是内网机器或有白名单 `IP`），再通过 `B` 访问 `C`
- 最终实现内网穿透

> [!CAUTION]
>
> 警告：这里的 `B` 主机很特殊，`B` 机器会有多个 `IP` 地址，也就是多插几条物理网线（或者其他虚拟网卡方案）而拥有了不同的相互独立的子网络的两个 `IP` 地址，不然 `A` 主机首先就无法访问 `B` 这台也处于内网的 `VPN` 主机（当然也有其他的方案）。

这就非常适合远程办公，但是成本比 `frp` 技术要高一些，尤其是 `frp` 对网线和物理网络环境没有特别苛刻的要求。

## 3.VPN 搭建

`WireGuard` 是现在最简单高效的 `Linux` 原生 `VPN` 方案，而企业私有 `VPN` 方案最常见的就是 `iNodeClient` 搭配自己搭建的 `iNode` 服务。